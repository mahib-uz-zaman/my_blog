{% extends 'blog/base.html' %}
{% block content %}
    <h1>{{ post.title }}</h1>
    <p>{{ post.content }}</p>
    {% if post.media %}
        <img src="{{ post.media.url }}" alt="{{ post.title }}" class="img-fluid">
    {% endif %}
    <p>By {{ post.author }} on {{ post.created_at }}</p>
    <p>{{ post.likes.filter(is_dislike=False).count }} Likes | {{ post.likes.filter(is_dislike=True).count }} Dislikes</p>
    <a href="{% url 'like_post' post.id %}" class="btn btn-primary">
        {% if request.user in post.likes.all and not post.likes.get(user=request.user).is_dislike %}Unlike{% else %}Like{% endif %}
    </a>
    <a href="{% url 'dislike_post' post.id %}" class="btn btn-danger">
        {% if request.user in post.likes.all and post.likes.get(user=request.user).is_dislike %}Undislike{% else %}Dislike{% endif %}
    </a>
    {% if post.author == request.user %}
        <form action="{% url 'delete_post' post.id %}" method="post" class="d-inline">
            {% csrf_token %}
            <button type="submit" class="btn btn-danger">Delete Post</button>
        </form>
    {% endif %}
    <hr>
    <h2>Comments</h2>
    <form method="post">
        {% csrf_token %}
        {{ form.as_p }}
        <button type="submit" class="btn btn-primary">Add Comment</button>
    </form>
    {% for comment in comments %}
        <div class="card mb-3">
            <div class="card-body">
                <p>{{ comment.content }}</p>
                <p>By {{ comment.author }} on {{ comment.created_at }}</p>
                {% if comment.author == request.user %}
                    <form action="{% url 'delete_comment' comment.id %}" method="post" class="d-inline">
                        {% csrf_token %}
                        <button type="submit" class="btn btn-danger btn-sm">Delete Comment</button>
                    </form>
                {% endif %}
                {% for reply in comment.replies.all %}
                    <div class="ms-4">
                        <p>{{ reply.content }}</p>
                        <p>By {{ reply.author }} on {{ reply.created_at }}</p>
                        {% if reply.author == request.user %}
                            <form action="{% url 'delete_comment' reply.id %}" method="post" class="d-inline">
                                {% csrf_token %}
                                <button type="submit" class="btn btn-danger btn-sm">Delete Reply</button>
                            </form>
                        {% endif %}
                    </div>
                {% endfor %}
            </div>
        </div>
    {% endfor %}
{% endblock %}